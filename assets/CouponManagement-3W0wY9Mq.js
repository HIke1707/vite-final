import{e as f,k as P,c as p,a as e,F as $,h as B,o as h,t as _,g as i,u as k,i as V,v}from"./index-MRf7kW_e.js";import{a as d}from"./axios-G2rPRu76.js";const F={class:"container"},J=e("div",{class:"col-md-8"},[e("h2",{class:"w50"},"優惠券維護列表")],-1),O={class:"row"},A={class:"col-md-12"},T={class:"table table-hover mt-4"},z=e("thead",null,[e("tr",null,[e("th",null,"優惠券編號"),e("th",null,"到期時間"),e("th",null,"優惠券標題"),e("th",null,"優惠券代碼"),e("th",null,"折價"),e("th",null,"狀態")])],-1),E={key:0},H=["onUpdate:modelValue","onChange"],W=e("option",{value:"0"},"停用",-1),Y=e("option",{value:"1"},"啟用",-1),j=[W,Y],q=["onClick"],G={key:1},I=e("td",null,null,-1),K=["onUpdate:modelValue"],Q=["onUpdate:modelValue"],R=["onUpdate:modelValue"],X=["onUpdate:modelValue"],Z=["onUpdate:modelValue"],tt=e("option",{value:"0"},"停用",-1),et=e("option",{value:"1"},"啟用",-1),st=[tt,et],at={__name:"CouponManagement",setup(nt){class y{constructor(s){this.title=(s==null?void 0:s.title)??"",this.is_enabled=(s==null?void 0:s.is_enabled)??0,this.percent=(s==null?void 0:s.percent)??0,this.discount=(s==null?void 0:s.discount)??0,this.due_date=(s==null?void 0:s.due_date)??0,this.code=(s==null?void 0:s.code)??""}}const r="https://ec-course-api.hexschool.io/v2",m="yangapi",u=f([]),C=f({}),g=async(o=1)=>{const s=`${r}/api/${m}/admin/coupons?page=${o}`;await d.get(s).then(t=>{u.value=t.data.coupons.map(n=>({...n,status:"stay"})),C.value=t.data.pagination}).catch(t=>{console.log(t)})},U=()=>{u.value.push({...new y,status:"new"})},x=async()=>{const o=u.value.filter(l=>l.status==="edited"),s=u.value.filter(l=>l.status==="new"),t=u.value.filter(l=>l.status==="remove"),n=[],a=o.map(async l=>{await D(l)||n.push(l)}),c=s.map(async l=>{await M(l)||n.push(l)}),b=t.map(async l=>{await S(l)||n.push(l)});await Promise.all([...a,...c,...b]),n.length>0?alert("操作失敗，請檢查優惠卷資訊"):(alert("儲存成功"),g())},D=async o=>{const s=`${r}/api/${m}/admin/coupon/${o.id}`;let t=!1;const n={data:new y(o)};return await d.put(s,n).then(a=>{const{success:c}=a.data;t=c}).catch(a=>{alert(JSON.stringify(a))}),t},M=async o=>{const s=`${r}/api/${m}/admin/coupon`;let t=!1;const n={data:new y(o)};return n.data.due_date=new Date(n.data.due_date).getTime(),await d.post(s,n).then(a=>{const{success:c}=a.data;t=c}).catch(a=>{alert(JSON.stringify(a))}),t},S=async o=>{const s=o.id,t=`${r}/api/${m}/admin/coupon/${s}`;let n=!1;return await d.delete(t).then(a=>{const{success:c}=a.data;n=c}).catch(a=>{alert(JSON.stringify(a))}),n},L=o=>{const s=new Date(o),t=s.getFullYear(),n=("0"+(s.getMonth()+1)).slice(-2),a=("0"+s.getDate()).slice(-2),c=("0"+s.getHours()).slice(-2),b=("0"+s.getMinutes()).slice(-2),l=("0"+s.getSeconds()).slice(-2);return`${t}-${n}-${a} ${c}:${b}:${l}`},N=async()=>{const o=`${r}/api/user/check`;let s=!1;return await d.post(o).then(t=>{const{success:n}=t.data;s=n}).catch(t=>{alert(t.message)}),s};return P(()=>{var s;const o=(s=document.cookie.split("; ").find(t=>t.startsWith("hextoken=")))==null?void 0:s.split("=")[1];d.defaults.headers.common.Authorization=o,console.log(o),N().then(t=>{t?g():(alert("請登入"),window.location="#/admin")})}),(o,s)=>(h(),p("div",F,[e("div",{class:"row"},[J,e("div",{class:"col-md-4"},[e("button",{type:"button",class:"btn btn-primary",onClick:x}," 儲存 ")])]),e("div",O,[e("div",A,[e("table",T,[z,e("tbody",null,[(h(!0),p($,null,B(u.value,t=>(h(),p($,{key:t.id},[t.status=="stay"||t.status=="edited"?(h(),p("tr",E,[e("td",null,_(t.id),1),e("td",null,_(L(t.due_date)),1),e("td",null,_(t.title),1),e("td",null,_(t.code),1),e("td",null,_(t.discount),1),e("td",null,[i(e("select",{class:"form-select","aria-label":"Disabled select example","onUpdate:modelValue":n=>t.is_enabled=n,onChange:n=>t.status="edited"},j,40,H),[[k,t.is_enabled,void 0,{number:!0}]])]),e("td",null,[e("button",{type:"button",class:"btn btn-danger",onClick:n=>t.status="remove"}," 移除 ",8,q)])])):V("",!0),t.status=="new"?(h(),p("tr",G,[I,e("td",null,[i(e("input",{type:"date","onUpdate:modelValue":n=>t.due_date=n},null,8,K),[[v,t.due_date]])]),e("td",null,[i(e("input",{type:"text","onUpdate:modelValue":n=>t.title=n},null,8,Q),[[v,t.title]])]),e("td",null,[i(e("input",{type:"text","onUpdate:modelValue":n=>t.code=n},null,8,R),[[v,t.code]])]),e("td",null,[i(e("input",{type:"number","onUpdate:modelValue":n=>t.discount=n},null,8,X),[[v,t.discount]])]),e("td",null,[i(e("select",{class:"form-select","aria-label":"Disabled select example","onUpdate:modelValue":n=>t.is_enabled=n},st,8,Z),[[k,t.is_enabled,void 0,{number:!0}]])])])):V("",!0)],64))),128))])])])]),e("div",{class:"row"},[e("div",{class:"col-md-12"},[e("button",{type:"button",class:"btn btn-primary",onClick:U}," 新增 ")])])]))}};export{at as default};
